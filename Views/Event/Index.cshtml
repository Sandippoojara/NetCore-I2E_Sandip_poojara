@model IEnumerable<EventManagementSystem.Models.Event>

<div class="container mt-5">

    <h2 class="mb-4">Upcoming Events</h2>

    @if (User.Identity?.IsAuthenticated ?? false)
    {
        <p class="text-muted">
            Welcome, <strong>@User.Identity.Name</strong> ! You can register for events below.
        </p>
    }

    <button class="btn btn-success mb-4" onclick="openCreateEvent()">
        Create New Event
    </button>

    <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
            <thead class="table-dark">
                <tr>
                    <th>Title</th>
                    <th>Date</th>
                    <th>Location</th>
                    <th class="text-center">Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    <tr>
                        <td>@item.Title</td>
                        <td>@item.EventDate.ToShortDateString()</td>
                        <td>@item.Location</td>
                        <td class="text-center">

                            <!-- VIEW BUTTON -->
                            <button class="btn btn-info btn-sm me-1 mb-1"
                                    onclick="openDetails(@item.Id)">
                                View
                            </button>

                            @if (User.IsInRole("Admin"))
                            {
                                <button class="btn btn-warning btn-sm me-1 mb-1"
                                        onclick="openEditEvent(@item.Id)">
                                    Edit
                                </button>

                                <button class="btn btn-danger btn-sm me-1 mb-1"
                                        onclick="confirmDeleteEvent(@item.Id)">
                                    Delete
                                </button>
                            }

                            @if (User.Identity?.IsAuthenticated ?? false)
                            {
                                <!-- REGISTER BUTTON -->
                                <button class="btn btn-primary btn-sm me-1 mb-1"
                                        onclick="openRegister(@item.Id)">
                                    Register
                                </button>
                            }
                            else
                            {
                                <!-- LOGIN BUTTON -->
                                <button class="btn btn-secondary btn-sm me-1 mb-1"
                                        onclick="openLogin()">
                                    Login
                                </button>
                            }

                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

</div>



<script>
    function handleUnauthorized(response) {
        if (response.status === 401 || response.status === 403) {
            response.json().then(data => {
                alert(data.message);
            });
            return false;
        }
        return true;
    }

    function openCreateEvent() {
        fetch('/events/create')
            .then(response => {
                if (!handleUnauthorized(response)) return;
                window.location.href = '/events/create';
            });
    }

    function openEditEvent(id) {
        fetch(`/events/edit/${id}`)
            .then(response => {
                if (!handleUnauthorized(response)) return;
                window.location.href = `/events/edit/${id}`;
            });
    }

    function confirmDeleteEvent(id) {
        if (!confirm("Are you sure you want to delete this event?")) {
            return;
        }

        fetch(`/events/delete/${id}`)
            .then(response => {
                if (!handleUnauthorized(response)) return;
                window.location.href = `/events/delete/${id}`;
            });
    }

    // 🔹 VIEW DETAILS
    function openDetails(id) {
        window.location.href = `/events/${id}`;
    }

    // 🔹 REGISTER
    function openRegister(eventId) {
        //window.location.href = `/Registration/Register?eventId=${eventId}`;
        window.location.href = `/register/${eventId}`;

    }

    // 🔹 LOGIN
    function openLogin() {
        window.location.href = `/Identity/Account/Login`;
    }
</script>
